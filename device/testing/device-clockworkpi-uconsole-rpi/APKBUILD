# Reference: <https://postmarketos.org/devicepkg>
# Maintainer: Federico Amedeo Izzo <federico@izzo.pro>
pkgname=device-clockworkpi-uconsole-rpi
pkgdesc="Clockwork Tech ClockworkPi uConsole with Raspberry Pi compute modules"
pkgver=4
pkgrel=0
url="https://postmarketos.org"
license="MIT"
arch="aarch64"
options="!check !archcheck"
depends="
	linux-clockworkpi-uconsole-rpi
	postmarketos-base
	raspberrypi-bootloader
"
makedepends="devicepkg-dev"
subpackages="
	$pkgname-nonfree-firmware:nonfree_firmware
	$pkgname-openrc
	$pkgname-x11
"
source="
	deviceinfo
	modules-initfs
	usercfg.txt
	95-vchiq-permissions.rules
	xorg.conf
"
provides="device-clockworkpi-uconsole-cm4=$pkgver-r$pkgrel"

build() {
	devicepkg_build $startdir $pkgname
}

package() {
	devicepkg_package $startdir $pkgname
	install -Dm644 "$srcdir"/usercfg.txt "$pkgdir"/boot/usercfg.txt
	install -Dm644 "$srcdir"/95-vchiq-permissions.rules \
		"$pkgdir"/usr/lib/udev/rules.d/95-vchiq-permissions.rules
}

nonfree_firmware() {
	pkgdesc="WiFi/Bluetooth firmware"
	depends="linux-firmware-brcm"
	mkdir "$subpkgdir"
}

x11() {
	install_if="$pkgname xorg-server"
	install -Dm644 "$srcdir"/xorg.conf \
		"$subpkgdir"/etc/X11/xorg.conf.d/10-monitor.conf
}

openrc() {
	install_if="$pkgname=$pkgver-r$pkgrel openrc"
	install="$subpkgname.post-install $subpkgname.post-upgrade"
	depends="openrc"

	mkdir -p "$subpkgdir"
}

sha512sums="
b9f17e497f9e9ed3e6c356cd48af150e255d9a90c2debace222703e2c900989c1bf1c07ad3be7b58358807e954fa5d978a3b8f317657ff27cedcda8f959ecdaf  deviceinfo
d97e603ef83626ec12a2503035c8de4d3d4d548510b85b26b07382736c334ae0c420e6811612fa83795eb8aa349dae29ec9944708d57cdd04cce09db3c32de23  modules-initfs
5f5dee9320be0f170f1284ebb7fa49c92802350f9621336c21c864d111fa99dd6007077fdccd45c828c2e31da1e46d29341063dcc8901a4f40935794b9486d6d  usercfg.txt
7e5505cb07d5b4a81bd28443d508336b5c547356538f1c06f91ed93ad0d7d456d4f74f1d24df5a2e08c17e74f0a66607352ac4874e967e9a91dfec9522d2d58d  95-vchiq-permissions.rules
15cde27e41304f988009e3a1cbc4bb6a85b9d09538c727e9c22e1ec8a45d025b4be5d0064d7d7bba1988006ad291c06c8aec8bcc974f0689fbd0d187f8dc6979  xorg.conf
"
